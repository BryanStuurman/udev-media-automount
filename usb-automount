#!/bin/bash
#$1 = <action>/<dev>/<name>

[[ $EUID != 0 ]] && exit 1

req="$(tr / - <<<"$1")"
#debug
echo "$(date): $req" >> /tmp/usb-automount

# clean
for usb in $(ls /usb); do
    mountpoint -q "/usb/$usb" || rmdir "/usb/$usb"
done

action="$(cut -d - -f 1 <<<"$req")"
dev="$(cut -d - -f 2 <<<"$req")"
name="$(cut -d - -f 3- <<<"$req")"
usb="$name-$dev"
if [[ "$action" == mount ]]; then
    mkdir -p "/usb/$usb"
    if mount "/dev/$dev" "/usb/$usb"; then
        for username in $(users); do
            if [[ $(id -u "$username") != 0 ]]; then
                su "$username" xdg-open "/usb/$usb"
                break
            fi
        done
    else
        rmdir "/usb/$usb" 
    fi
elif [[ "$action" == umount ]]; then
    [[ "$usb" == "" || ! -d "/usb/$usb" ]] && exit 1
    umount "/usb/$usb"
    rmdir "/usb/$usb"
else
    exit 1
fi

exit 0
